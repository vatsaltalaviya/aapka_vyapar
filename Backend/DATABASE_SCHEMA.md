# Database Schema Documentation

## Overview

This document provides a detailed overview of the MongoDB database schema for the Aapka Vyapar application.

---

## Collections Summary

| Collection | Purpose | Relationships |
|------------|---------|---------------|
| users | User authentication and profile | One-to-Many with BusinessDetails |
| businessdetails | Business information | Many-to-One with Users, One-to-Many with Items |
| itemdatas | Inventory items | Many-to-One with BusinessDetails, References to 13 item field collections |
| categories | Item categories | Referenced by Items |
| barcodes | Item barcodes | Referenced by Items |
| hsns | HSN codes | Referenced by Items |
| units | Primary units | Referenced by Items |
| secondaryunits | Secondary units | Referenced by Items |
| saleprices | Sale prices | Referenced by Items |
| discounts | Discount information | Referenced by Items |
| openingstocks | Opening stock quantities | Referenced by Items |
| stockprices | Stock prices | Referenced by Items |
| purchaseprices | Purchase prices | Referenced by Items |
| itemlocations | Storage locations | Referenced by Items |
| stockdates | Stock dates | Referenced by Items |
| minstocks | Minimum stock quantities | Referenced by Items |

---

## Detailed Schema Definitions

### 1. Users Collection

**Collection Name**: `users`  
**Model File**: `models/User.js`

```javascript
{
  _id: ObjectId,                    // Auto-generated MongoDB ID
  username: {
    type: String,
    required: true,
    trim: true,
    minlength: 3
  },
  email: {
    type: String,
    required: true,
    unique: true,                   // Unique index
    lowercase: true,
    trim: true
  },
  password: {
    type: String,
    required: true,
    minlength: 6                    // Stored as bcrypt hash
  },
  otp: {
    type: Number,
    default: 0                      // Used for password reset
  },
  otpexpiresAt: {
    type: Date                      // OTP expiration timestamp
  }
}
```

**Indexes**:
- `email`: Unique index for fast lookup and uniqueness constraint

**Relationships**:
- One User → Many BusinessDetails (via `userId` in BusinessDetails)

---

### 2. BusinessDetails Collection

**Collection Name**: `businessdetails`  
**Model File**: `models/BusinessDetails.js`

```javascript
{
  _id: ObjectId,                    // Auto-generated MongoDB ID
  businessName: {
    type: String,
    required: true,
    default: ''
  },
  GstNo: {
    type: String,
    required: true,
    default: ''
  },
  businessPhoneNumber1: {
    type: String,
    required: true,
    default: null
  },
  businessPhoneNumber2: {
    type: String,
    required: true,
    default: null
  },
  businessAddress: {
    type: String,
    required: true,
    default: ''
  },
  businessEmail: {
    type: String,
    required: true,
    unique: true,                   // Unique index
    default: ''
  },
  businessPincode: {
    type: Number,
    required: true,
    default: null
  },
  businessDescription: {
    type: String,
    required: false,
    default: ''
  },
  signature: {
    type: String,
    required: false,
    default: ''
  },
  userId: {
    type: ObjectId,
    ref: 'User',                    // Foreign key to Users collection
    required: true
  },
  createdAt: Date,                  // Auto-generated by timestamps
  updatedAt: Date                   // Auto-generated by timestamps
}
```

**Indexes**:
- `businessEmail`: Unique index
- `userId`: Index for efficient queries

**Relationships**:
- Many BusinessDetails → One User (via `userId`)
- One BusinessDetails → Many Items (via `businessId` in Items)

---

### 3. Items Collection

**Collection Name**: `itemdatas`  
**Model File**: `models/items.js`

```javascript
{
  _id: ObjectId,                    // Auto-generated MongoDB ID
  itemName: {
    type: String,
    required: true,
    trim: true
  },
  itemcode: {
    type: ObjectId,
    ref: 'Barcode',                 // Foreign key to Barcodes collection
    required: true
  },
  itemCategory: {
    type: ObjectId,
    ref: 'Category'                 // Foreign key to Categories collection
  },
  HSNCode: {
    type: ObjectId,
    ref: 'HSN',                     // Foreign key to HSNs collection
    required: true
  },
  unit: {
    primaryUnit: {
      type: ObjectId,
      ref: 'Unit',                  // Foreign key to Units collection
      required: true
    },
    secondaryUnit: {
      type: ObjectId,
      ref: 'SecondaryUnit',         // Foreign key to SecondaryUnits collection
      required: false
    }
  },
  Pricing: {
    salePrice: {
      type: ObjectId,
      ref: 'SalePrice',             // Foreign key to SalePrices collection
      required: false,
      trim: true
    },
    Discount: {
      type: ObjectId,
      ref: 'discount',              // Foreign key to Discounts collection
      required: false,
      min: 0
    },
    withTax: {
      type: Boolean,
      default: false
    }
  },
  stock: {
    quantity: {
      type: ObjectId,
      ref: 'openingStock'           // Foreign key to OpeningStocks collection
    },
    stockPrice: {
      type: ObjectId,
      ref: 'stockPrice'             // Foreign key to StockPrices collection
    },
    minimumStock: {
      type: ObjectId,
      ref: 'minstock'               // Foreign key to MinStocks collection
    },
    stockDate: {
      type: ObjectId,
      ref: 'stockDate'              // Foreign key to StockDates collection
    },
    itemLocation: {
      type: ObjectId,
      ref: 'itemLocation'           // Foreign key to ItemLocations collection
    }
  },
  purchasePrice: {
    type: ObjectId,
    ref: 'purchasePrice'            // Foreign key to PurchasePrices collection
  },
  tax: {
    type: Number,
    required: function() {
      return this.Pricing?.withTax; // Required only if withTax is true
    }
  },
  businessId: {
    type: ObjectId,
    ref: 'BusinessDetails',         // Foreign key to BusinessDetails collection
    required: true
  }
}
```

**Indexes**:
- `businessId`: Index for efficient business-specific queries
- `itemcode`: Index for barcode lookups
- `itemCategory`: Index for category filtering

**Relationships**:
- Many Items → One BusinessDetails (via `businessId`)
- Many Items → One Barcode (via `itemcode`)
- Many Items → One Category (via `itemCategory`)
- Many Items → One HSN (via `HSNCode`)
- Many Items → One Unit (via `unit.primaryUnit`)
- Many Items → One SecondaryUnit (via `unit.secondaryUnit`)
- Many Items → One SalePrice (via `Pricing.salePrice`)
- Many Items → One Discount (via `Pricing.Discount`)
- Many Items → One OpeningStock (via `stock.quantity`)
- Many Items → One StockPrice (via `stock.stockPrice`)
- Many Items → One MinStock (via `stock.minimumStock`)
- Many Items → One StockDate (via `stock.stockDate`)
- Many Items → One ItemLocation (via `stock.itemLocation`)
- Many Items → One PurchasePrice (via `purchasePrice`)

---

## Item Field Collections

All item field collections follow a similar simple structure with timestamps.

### 4. Categories Collection

**Collection Name**: `categories`  
**Model File**: `models/ItemFieldModels/Category.js`

```javascript
{
  _id: ObjectId,
  categoryName: {
    type: String,
    required: true,
    default: ''
  },
  createdAt: Date,
  updatedAt: Date
}
```

### 5. Barcodes Collection

**Collection Name**: `barcodes`  
**Model File**: `models/ItemFieldModels/Barcode.js`

```javascript
{
  _id: ObjectId,
  barcode: {
    type: String,
    required: true,
    default: ''
  },
  createdAt: Date,
  updatedAt: Date
}
```

### 6. HSNs Collection

**Collection Name**: `hsns`  
**Model File**: `models/ItemFieldModels/HSN.js`

```javascript
{
  _id: ObjectId,
  hsnCode: {
    type: String,
    required: true,
    default: ''
  },
  createdAt: Date,
  updatedAt: Date
}
```

### 7. Units Collection

**Collection Name**: `units`  
**Model File**: `models/ItemFieldModels/Unit.js`

```javascript
{
  _id: ObjectId,
  unitName: {
    type: String,
    required: true,
    default: ''
  },
  createdAt: Date,
  updatedAt: Date
}
```

### 8. SecondaryUnits Collection

**Collection Name**: `secondaryunits`  
**Model File**: `models/ItemFieldModels/SecondaryUnit.js`

```javascript
{
  _id: ObjectId,
  secondaryUnitName: {
    type: String,
    required: true,
    default: ''
  },
  createdAt: Date,
  updatedAt: Date
}
```

### 9. SalePrices Collection

**Collection Name**: `saleprices`  
**Model File**: `models/ItemFieldModels/salePrice.js`

```javascript
{
  _id: ObjectId,
  price: {
    type: Number,
    required: true,
    default: 0
  },
  createdAt: Date,
  updatedAt: Date
}
```

### 10. Discounts Collection

**Collection Name**: `discounts`  
**Model File**: `models/ItemFieldModels/discount.js`

```javascript
{
  _id: ObjectId,
  discountPercentage: {
    type: Number,
    required: true,
    default: 0,
    min: 0,
    max: 100
  },
  createdAt: Date,
  updatedAt: Date
}
```

### 11. OpeningStocks Collection

**Collection Name**: `openingstocks`  
**Model File**: `models/ItemFieldModels/openingStock.js`

```javascript
{
  _id: ObjectId,
  quantity: {
    type: Number,
    required: true,
    default: 0
  },
  createdAt: Date,
  updatedAt: Date
}
```

### 12. StockPrices Collection

**Collection Name**: `stockprices`  
**Model File**: `models/ItemFieldModels/stockPrice.js`

```javascript
{
  _id: ObjectId,
  price: {
    type: Number,
    required: true,
    default: 0
  },
  createdAt: Date,
  updatedAt: Date
}
```

### 13. PurchasePrices Collection

**Collection Name**: `purchaseprices`  
**Model File**: `models/ItemFieldModels/purchasePrice.js`

```javascript
{
  _id: ObjectId,
  price: {
    type: Number,
    required: true,
    default: 0
  },
  createdAt: Date,
  updatedAt: Date
}
```

### 14. ItemLocations Collection

**Collection Name**: `itemlocations`  
**Model File**: `models/ItemFieldModels/itemLocation.js`

```javascript
{
  _id: ObjectId,
  location: {
    type: String,
    required: true,
    default: ''
  },
  createdAt: Date,
  updatedAt: Date
}
```

### 15. StockDates Collection

**Collection Name**: `stockdates`  
**Model File**: `models/ItemFieldModels/stockDate.js`

```javascript
{
  _id: ObjectId,
  date: {
    type: Date,
    required: true,
    default: Date.now
  },
  createdAt: Date,
  updatedAt: Date
}
```

### 16. MinStocks Collection

**Collection Name**: `minstocks`  
**Model File**: `models/ItemFieldModels/minStockQuantity.js`

```javascript
{
  _id: ObjectId,
  quantity: {
    type: Number,
    required: true,
    default: 0
  },
  createdAt: Date,
  updatedAt: Date
}
```

---

## Entity Relationship Diagram (ERD)

```
┌─────────────────┐
│     Users       │
│─────────────────│
│ _id (PK)        │
│ username        │
│ email (UNIQUE)  │
│ password        │
│ otp             │
│ otpexpiresAt    │
└────────┬────────┘
         │ 1
         │
         │ N
┌────────▼──────────────┐
│  BusinessDetails      │
│───────────────────────│
│ _id (PK)              │
│ businessName          │
│ GstNo                 │
│ businessPhoneNumber1  │
│ businessPhoneNumber2  │
│ businessAddress       │
│ businessEmail (UNIQUE)│
│ businessPincode       │
│ businessDescription   │
│ signature             │
│ userId (FK)           │
│ createdAt             │
│ updatedAt             │
└────────┬──────────────┘
         │ 1
         │
         │ N
┌────────▼──────────────┐
│      Items            │
│───────────────────────│
│ _id (PK)              │
│ itemName              │
│ itemcode (FK)         │──────► Barcodes
│ itemCategory (FK)     │──────► Categories
│ HSNCode (FK)          │──────► HSNs
│ unit.primaryUnit (FK) │──────► Units
│ unit.secondaryUnit(FK)│──────► SecondaryUnits
│ Pricing.salePrice(FK) │──────► SalePrices
│ Pricing.Discount (FK) │──────► Discounts
│ Pricing.withTax       │
│ stock.quantity (FK)   │──────► OpeningStocks
│ stock.stockPrice (FK) │──────► StockPrices
│ stock.minimumStock(FK)│──────► MinStocks
│ stock.stockDate (FK)  │──────► StockDates
│ stock.itemLocation(FK)│──────► ItemLocations
│ purchasePrice (FK)    │──────► PurchasePrices
│ tax                   │
│ businessId (FK)       │
└───────────────────────┘
```

---

## Data Flow

### 1. User Registration Flow
```
1. User submits registration data
2. Password is hashed using bcrypt
3. User document created in 'users' collection
4. JWT tokens generated and returned
```

### 2. Business Creation Flow
```
1. Authenticated user submits business details
2. System validates userId from JWT token
3. Business document created in 'businessdetails' collection
4. userId field links business to user
```

### 3. Item Creation Flow
```
1. User creates item field entries (category, barcode, etc.)
   - Each field stored in respective collection
   - Returns ObjectId for each entry
   
2. User creates item with references
   - Item document created in 'itemdatas' collection
   - All field ObjectIds stored as references
   - businessId links item to business
   
3. When querying items:
   - Use .populate() to fetch referenced data
   - Example: Item.find().populate('itemCategory').populate('itemcode')
```

---

## Query Examples

### Get User with All Businesses
```javascript
const user = await UserModel.findById(userId);
const businesses = await BusinessDetails.find({ userId: user._id });
```

### Get All Items for a Business (with populated fields)
```javascript
const items = await itemData
  .find({ businessId: businessId })
  .populate('itemcode')
  .populate('itemCategory')
  .populate('HSNCode')
  .populate('unit.primaryUnit')
  .populate('unit.secondaryUnit')
  .populate('Pricing.salePrice')
  .populate('Pricing.Discount')
  .populate('stock.quantity')
  .populate('stock.stockPrice')
  .populate('stock.minimumStock')
  .populate('stock.stockDate')
  .populate('stock.itemLocation')
  .populate('purchasePrice');
```

### Get Business with User Details
```javascript
const business = await BusinessDetails
  .findById(businessId)
  .populate('userId', '-password'); // Exclude password
```

---

## Indexing Strategy

### Current Indexes
1. **users.email**: Unique index for authentication
2. **businessdetails.businessEmail**: Unique index for business uniqueness
3. **businessdetails.userId**: Index for user-business queries

### Recommended Additional Indexes
```javascript
// For better performance on item queries
db.itemdatas.createIndex({ businessId: 1 });
db.itemdatas.createIndex({ itemcode: 1 });
db.itemdatas.createIndex({ itemCategory: 1 });
db.itemdatas.createIndex({ itemName: "text" }); // For text search

// For business queries
db.businessdetails.createIndex({ GstNo: 1 });
```

---

## Data Validation Rules

### User Collection
- Email must be unique and valid format
- Password minimum 6 characters (hashed before storage)
- Username minimum 3 characters

### BusinessDetails Collection
- GST number must be unique per user
- Business email must be unique globally
- Phone numbers required
- Pincode must be numeric

### Items Collection
- Item name required
- Must reference valid barcode, HSN, and primary unit
- Tax required only if withTax is true
- Must belong to a valid business

---

## Backup and Maintenance

### Recommended Backup Strategy
```bash
# Daily backup
mongodump --db aapka_vyapar --out /backup/$(date +%Y%m%d)

# Restore from backup
mongorestore --db aapka_vyapar /backup/20260128
```

### Data Cleanup
```javascript
// Remove expired OTPs (run daily)
db.users.updateMany(
  { otpexpiresAt: { $lt: new Date() } },
  { $set: { otp: 0, otpexpiresAt: null } }
);
```

---

## Performance Considerations

1. **Use Indexes**: Ensure proper indexes on frequently queried fields
2. **Limit Populate**: Only populate fields you need
3. **Pagination**: Implement pagination for large item lists
4. **Projection**: Use field projection to limit returned data
5. **Caching**: Consider caching frequently accessed data (categories, units)

---

## Migration Notes

When adding new fields or collections:
1. Update model files
2. Update controllers
3. Update API documentation
4. Run migration scripts if needed
5. Update indexes
6. Test thoroughly before deployment

---

**Last Updated**: January 2026  
**Schema Version**: 1.0.0
